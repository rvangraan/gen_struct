<html>
<head><title>.eunit/gen_struct_transform.COVER.html</title></head><body bgcolor=white text=black>
<pre>
File generated from /home/shomodj/workspace/osw/core/lib/gen_struct/.eunit/gen_struct_transform.erl by COVER 2011-05-15 at 20:36:29

****************************************************************************

        |  %%----------------------------------------------------------------------------------------------------
        |  -module(gen_struct_transform).
        |  %%----------------------------------------------------------------------------------------------------
        |  -export([parse_transform/2]).
        |  %%----------------------------------------------------------------------------------------------------
        |  %% TODO create state
        |  -record(state,{eof, ast, opt, record_name, module_name, record_fields}).
        |  %%----------------------------------------------------------------------------------------------------
        |  
        |  parse_transform(AST,Options) -&gt;
        |    % io:format("AST: \n~p\n",[AST]),
<font color=red>     0..|    NewAST = try</font>
        |  %%    State = #state{ast=AST, opt=Options},
<font color=red>     0..|      LastLineNumber = get_last_line_number(AST),</font>
<font color=red>     0..|      ModuleName = get_module_name(AST),</font>
<font color=red>     0..|      ModuleRecord = get_record(ModuleName,AST),</font>
<font color=red>     0..|      RecordFields = get_record_fields(ModuleRecord),</font>
        |      % io:format("LastLineNumber: ~p\n",[LastLineNumber]),
        |      % io:format("ModuleName: ~p\n",[ModuleName]),
        |      % io:format("ModuleRecord: ~p\n",[ModuleRecord]),
        |      % io:format("RecordFields: ~p\n",[RecordFields]),
        |  
<font color=red>     0..|      {InsertAST1,LastLineNumber1} = gen_fields_idx_fun_ast(RecordFields,LastLineNumber),</font>
<font color=red>     0..|      {AST1,LastLineNumber2} = insert_before_eof(AST,InsertAST1,LastLineNumber1),</font>
        |  
<font color=red>     0..|      {InsertAST2,LastLineNumber3} = gen_fields_lst_fun_ast(RecordFields,LastLineNumber2),</font>
<font color=red>     0..|      {AST2,LastLineNumber4} = insert_before_eof(AST1,InsertAST2,LastLineNumber3),</font>
        |  
<font color=red>     0..|      {AST3,LastLineNumber5} = insert_record_ast_fun(AST2,ModuleName,LastLineNumber4),</font>
<font color=red>     0..|      {AST4,LastLineNumber6} = insert_init_ast_fun(AST3,LastLineNumber5),</font>
        |  
        |  %%    io:format("AST: ~p\n",[AST4]),
<font color=red>     0..|      AST4</font>
        |  
        |    catch
        |      throw:{invalid_record_field,Params} -&gt;
<font color=red>     0..|        io:format("Unable to parse record field: ~p\n",[proplists:get_value(field,Params)]),</font>
<font color=red>     0..|        throw(stop);</font>
        |  
        |      throw:{record_does_not_exist,Params} -&gt;
<font color=red>     0..|        io:format("Record: ~p does not exist!\n",[proplists:get_value(record,Params)]),</font>
<font color=red>     0..|        AST;</font>
        |  
        |      C:E -&gt;
<font color=red>     0..|        io:format("Class: ~p, Excaption: ~p\nStacktrace: ~p\n",[C,E,erlang:get_stacktrace()]),</font>
<font color=red>     0..|        throw(stop)</font>
        |    end,
<font color=red>     0..|    NewAST.</font>
        |  
        |  %%----------------------------------------------------------------------------------------------------
        |  
<font color=red>     0..|  has_function(FunctionName,Arity,[])                                         -&gt; false;</font>
<font color=red>     0..|  has_function(FunctionName,Arity,[{function,_,FunctionName,Arity,_}=_Fun|_]) -&gt; true;</font>
<font color=red>     0..|  has_function(FunctionName,Arity,[_|Rest])                                   -&gt; has_function(FunctionName,Arity,Rest).</font>
        |  
        |  %%----------------------------------------------------------------------------------------------------
        |  
<font color=red>     0..|  get_last_line_number([{eof,LineNum}|_]) -&gt; LineNum;</font>
<font color=red>     0..|  get_last_line_number([_|Rest])          -&gt; get_last_line_number(Rest).</font>
        |  
        |  %%----------------------------------------------------------------------------------------------------
        |  
<font color=red>     0..|  get_module_name([{attribute,_,module,ModuleName}|_]) -&gt; ModuleName;</font>
<font color=red>     0..|  get_module_name([_|Rest])                            -&gt; get_module_name(Rest).</font>
        |  
        |  %%----------------------------------------------------------------------------------------------------
        |  
<font color=red>     0..|  get_record(RecordName,[])                                             -&gt; throw({record_does_not_exist,[{record,RecordName}]});</font>
<font color=red>     0..|  get_record(RecordName,[{attribute,_,record,{RecordName,_}=Record}|_]) -&gt; Record;</font>
<font color=red>     0..|  get_record(RecordName,[_|Rest])                                       -&gt; get_record(RecordName,Rest).</font>
        |  
        |  %%----------------------------------------------------------------------------------------------------
        |  
        |  get_record_fields({_RecordName,RecordFields}) -&gt;
<font color=red>     0..|    get_record_fields_loop(RecordFields,[]).</font>
        |  
<font color=red>     0..|  get_record_fields_loop([],Acc)                                                       -&gt; lists:reverse(Acc);</font>
<font color=red>     0..|  get_record_fields_loop([{record_field,_,{atom,_,FieldName}}|Rest],Acc)               -&gt; get_record_fields_loop(Rest,[FieldName|Acc]);</font>
<font color=red>     0..|  get_record_fields_loop([{record_field,_,{atom,_,FieldName},_DefaultValue}|Rest],Acc) -&gt; get_record_fields_loop(Rest,[FieldName|Acc]);</font>
<font color=red>     0..|  get_record_fields_loop([Field|_Rest],_Acc)                                           -&gt; throw({invalid_record_field,[{field,Field}]}).</font>
        |  
        |  
        |  %%----------------------------------------------------------------------------------------------------
        |  
        |  gen_fields_idx_fun_ast(Fields,LastLineNumber) -&gt;
<font color=red>     0..|    gen_fields_idx_fun_ast_loop(Fields,LastLineNumber,2,[]). %% 2 because first element is module_name</font>
        |  
        |  
        |  gen_fields_idx_fun_ast_loop([],LastLineNumber,_,Acc) -&gt; 
<font color=red>     0..|    Acc1 = Acc ++ "'=field'(_) -&gt; throw(invalid_field). \n",</font>
<font color=red>     0..|    from_str_to_ast(Acc1,LastLineNumber);</font>
        |  
        |  gen_fields_idx_fun_ast_loop([Field|Fields],LastLineNumber,Index,Acc) -&gt;
<font color=red>     0..|    Acc1 = Acc ++ "'=field'(" ++ atom_to_list(Field) ++") -&gt; "++ integer_to_list(Index) ++"; \n",</font>
<font color=red>     0..|    gen_fields_idx_fun_ast_loop(Fields,LastLineNumber,Index+1,Acc1).</font>
        |  
        |  %%----------------------------------------------------------------------------------------------------
        |  
        |  gen_fields_lst_fun_ast(Fields,LastLineNumber) -&gt;
<font color=red>     0..|    Lst = "'=fields'() -&gt; [ " ++ (lists:flatten([ ", " ++ atom_to_list(F) || F &lt;- Fields]) -- "," ) ++ " ].",</font>
<font color=red>     0..|    from_str_to_ast(Lst,LastLineNumber).</font>
        |  
        |  %%----------------------------------------------------------------------------------------------------
        |  
        |  insert_record_ast_fun(AST,RecordName,LastLineNumber) -&gt;
<font color=red>     0..|    Str = "'=record'() -&gt; #"++ atom_to_list(RecordName) ++"{} .",</font>
<font color=red>     0..|    {InsertAST,NewLastLineNumber} = from_str_to_ast(Str,LastLineNumber),</font>
<font color=red>     0..|    insert_before_eof(AST,InsertAST,NewLastLineNumber).</font>
        |  
        |  %%----------------------------------------------------------------------------------------------------
        |  
        |  insert_init_ast_fun(AST,LastLineNumber) -&gt;
<font color=red>     0..|    case has_function(init,1,AST) of</font>
        |      false -&gt; 
<font color=red>     0..|        Str = "init(Struct) -&gt; Struct.",</font>
<font color=red>     0..|        {InsertAST, NewLastLineNumber} = from_str_to_ast(Str,LastLineNumber),</font>
<font color=red>     0..|        insert_before_eof(AST,InsertAST,NewLastLineNumber);</font>
        |      true -&gt;
<font color=red>     0..|        {AST, LastLineNumber}</font>
        |    end.
        |  
        |  %%----------------------------------------------------------------------------------------------------
        |  
        |  from_str_to_ast(Str,LastLineNumber) -&gt;
<font color=red>     0..|    {ok, Tokens, NewLastLineNumber} = erl_scan:string(Str,LastLineNumber),</font>
<font color=red>     0..|    {ok, AST} = erl_parse:parse_form(Tokens),                             </font>
<font color=red>     0..|    {AST, NewLastLineNumber}.</font>
        |  
        |  %%----------------------------------------------------------------------------------------------------
        |  
        |  insert_before_eof(AST,InsertAST,NewLastLineNumber) -&gt;
<font color=red>     0..|    insert_before_eof_loop(AST,InsertAST,NewLastLineNumber,[]).</font>
        |  
        |  
        |  insert_before_eof_loop([{eof,_LastLineNumber}|_],InsertAST,NewLastLineNumber,Acc) -&gt; 
<font color=red>     0..|    Acc1 = [{eof,NewLastLineNumber},InsertAST|Acc],</font>
<font color=red>     0..|    {lists:reverse(Acc1),NewLastLineNumber};</font>
        |  
        |  insert_before_eof_loop([ASTElemnt|Rest],InsertAST,NumberOfLines,Acc) -&gt; 
<font color=red>     0..|    insert_before_eof_loop(Rest,InsertAST,NumberOfLines,[ASTElemnt|Acc]).</font>
        |  
        |  %%----------------------------------------------------------------------------------------------------
</pre>
</body>
</html>
